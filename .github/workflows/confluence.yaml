name: Publish Markdown to Confluence

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Convert Markdown â†’ Confluence HTML
        id: convert
        run: |
          INPUT="docs/page.md"
          OUTPUT="content.html"

          pandoc "$INPUT" \
          --from markdown \
          --to html \
          --standalone \
          --wrap=none \
          -o "$OUTPUT"

        # Encode safely
        CONTENT=$(base64 -w 0 content.html)
        echo "content=$CONTENT" >> $GITHUB_OUTPUT

      - name: Publish to Confluence
        env:
          CONF_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONF_TOKEN: ${{ secrets.CONFLUENCE_TOKEN }}
          CONF_URL:   ${{ secrets.CONFLUENCE_URL }}
          CONF_SPACE: ${{ secrets.CONFLUENCE_SPACE }}
          PAGE_ID:    ${{ secrets.CONFLUENCE_PAGE_ID }}
        run: |
          CONTENT="${{ steps.convert.outputs.content }}"

          if [ -z "$PAGE_ID" ]; then
            echo "Creating new page..."
            curl -X POST "$CONF_URL/rest/api/content" \
              -u "$CONF_EMAIL:$CONF_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"type\": \"page\",
                \"title\": \"Markdown Converted Page\",
                \"space\": { \"key\": \"$CONF_SPACE\" },
                \"body\": {
                  \"storage\": {
                    \"value\": \"$CONTENT\",
                    \"representation\": \"storage\"
                  }
                }
              }"
          else
            echo "Updating existing page..."

            VERSION=$(curl -s -u "$CONF_EMAIL:$CONF_TOKEN" \
              "$CONF_URL/rest/api/content/$PAGE_ID?expand=version" | jq '.version.number + 1')

            curl -X PUT "$CONF_URL/rest/api/content/$PAGE_ID" \
              -u "$CONF_EMAIL:$CONF_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"id\": \"$PAGE_ID\",
                \"type\": \"page\",
                \"title\": \"Markdown Converted Page\",
                \"space\": { \"key\": \"$CONF_SPACE\" },
                \"version\": { \"number\": $VERSION },
                \"body\": {
                  \"storage\": {
                    \"value\": \"$CONTENT\",
                    \"representation\": \"storage\"
                  }
                }
              }"
          fi
